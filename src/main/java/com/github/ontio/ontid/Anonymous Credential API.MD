# Ontology Anonymous Credential Java SDK

## Role

owner: credential owner, who hold some credentials and create presentation;

issuer: credential issuer, who issue credential;

verifier: credential verifier, who verify credential and presentation.

## Class Specification

### CredentialStatus

[code](./CredentialStatus.java)

Refer: https://www.w3.org/TR/vc-data-model/#status

There are three type credential status now, `SignatureContract`, `AttestContract` and `RevocationList`.

If `CredentialStatus.type` equals `AttestContract`, `CredentialStatus.id` should be `CredentialRecord` contract address.

### VerifiableCredential
[code](./anonymous/impl/FormatCredential.java)

Refer: https://www.w3.org/TR/vc-data-model/#basic-concepts

FormatCredential.issuer: issuer ontId.

### Proof

[code](./anonymous/impl/AnonymousProof.java)

Refer: https://www.w3.org/TR/vc-data-model/#proofs-signatures
Proof.type: proof type;

Proof.created: timestamp

ProofPurpose: only use `assertionMethod` at currently;

verificationMethod: pubkey uri;

signature: issuer signature;

### VerifiablePresentation

[code](./anonymous/impl/FormatPresentation.java)
Refer: https://www.w3.org/TR/vc-data-model/#presentations-0

FormatCredential.issuer: issuer ontId.

VerifiablePresentation.holder: maybe an ontId of String type or an object that has "id" attribute and "id" must be ontId.

### Request

[code](./anonymous/impl/Request.java)

attributes: request's attribute;

nonce: request's nonce (receive from issuer);

nym: request's nym;

zkp: request's zkp;

### Credential

[code](./anonymous/impl/Credential.java)

id: Credential's id;

signature: Credential's signature;

witness: Credential's witness;

#### Update credential witness

**public void updateCredentialWitness(Library library, byte[] issuerPublic, byte[] witness, byte[] accumulator)**

Used to update credential witness.

#### Revoke credential

**public boolean revokeCredential(Library library, Pointer issuer, Long id)**

Used to revoke credential.

#### Update issuer's witness

**public byte[] updateIssuerWitness(Library library, byte[] witness, Pointer issuer, Long id, byte isAdd)**

Used to update issuer witness.

#### Extract credential's witness

**public byte[] extractWitness(Library library)**

Used to extract credential witness.


### Presentation
[code](./anonymous/impl/Presentation.java)

attributes: credential owner's attributes;

proof: presentation's proof;

#### Verify presentation

**public boolean verify(Library library, byte[] issuerPublic, byte[] accumulator, byte[] nonce)**

Used to verify users's presentation.

### SDK

The OntId2 class is Ontology Anonymous Credential protocol SDK class.

#### OntId2

[code](./OntId2.java)

It's ONTID2 SDK class, all Ontology Anonymous Credential function should entry from here.

OntId2.OntId: ontId contract.

## API
There are many interfaces to use Ontology Anonymous Credential protocol.
### Constructor
1. **public OntId2(String ontId, Account signer, Library library, OntId ontIdContract)**

	Generate OntId2 object.

    If `ontId` not empty and `signer` not null, there will query `OntIdPubKey` from ontology chain and use it as self signer.
    
    The library is the anonymous credential library.
    
### Create credential

1. **createCredential(String issuerId, Pointer issuer, Request request, String[] context, String[] type, CredentialStatusType statusType, String verificationMethod, ProofPurpose purpose, Date expiration)**
    
    comment:
    * Create FormatCredential object.
    * Check expiration.
    * Generate proof.
    
    param: 
    * issuerId: maybe an ontId of String type or an object that has "id" attribute and "id" must be ontId;
    * issuer: the issuer object which is generated by the anonymous credential library.
    * request: credential owner's request which is generated by the issuer.
    * context: refer w3c definition;
    * type: refer w3c definition;
    * credentialStatusType: only use `AttestContract`, `SignatrueContract` and `RevocationList` at current;
    * verificationMethod: publicKey uri;
    * proofPurpose: only use `assertionMethod` at current;   
    * expiration: refer w3c definition;
        
2. **public FormatCredential createCredential(Credential credential, String issuerId, String[] context, String[] type, CredentialStatusType statusType, String verificationMethod, ProofPurpose purpose, Date expiration, String credentialSubject)**
   
    comment:
    * Update FormatCredential object.
    * Check expiration.
    * Generate proof.
    
    param:
    * credential: Credential object;
    * issuerId: maybe an ontId of String type or an object that has "id" attribute and "id" must be ontId;
    * context: refer w3c definition;
    * type: refer w3c definition;
    * credentialStatusType: only use `AttestContract`, `SignatrueContract` and `RevocationList` at current;
    * verificationMethod: publicKey uri;
    * proofPurpose: only use `assertionMethod` at current;   
    * expiration: refer w3c definition;
    * credentialSubject: refer w3c definition;

### Create presentation
 
1. **public FormatPresentation createPresentation(PresentationParam presentationParam, String issuerId, String holder, String[] context, String verificationMethod, ProofPurpose purpose)**
    
    comment:
    * Create FormatPresentation object.
    
    param:
    * presentationParam: parameters to be used to generate presentation.
    * issuerId: maybe an ontId of String type or an object that has "id" attribute and "id" must be ontId;
    * holder: maybe an ontId of String type or an object that has "id" attribute and "id" must be ontId;
    * context: refer w3c definition;
    * verificationMethod: public key uri;
    * proofPurpose: only use `assertionMethod` at current;
         
2. **public FormatPresentation createPresentation(Presentation presentation, String issuerId, String holder, String[] context, String verificationMethod, ProofPurpose purpose)**
    
    comment:
    * Update FormatPresentation Object;
    
    param:
    * presentation: Presentation object.
    * issuerId: maybe an ontId of String type or an object that has "id" attribute and "id" must be ontId;
    * holder: maybe an ontId of String type or an object that has "id" attribute and "id" must be ontId;
    * context: refer w3c definition;
    * verificationMethod: public key uri;
    * proofPurpose: only use `assertionMethod` at current;    
    
## Native API
[code](./anonymous/impl/LibraryImpl.java)

### Create issuer

**Pointer new_issuer()**

comment:
* create issuer object;

### Serialize issuer

**String serialize_issuer(Pointer issuer)**

comment:
* Used to serialize issuer;

param:
* issuer Object to be serialized;

### Deserialize issuer

**Pointer deserialize_issuer(String issuer_str)**

comment:
* Used to deserialize issuer string;

param: 
* issuer_str: issuer info;

### Free issuer

**free_issuer(Pointer issuer)**

comment:
* In order to prevent memory leaks, you should invoke this function to collect issuer object.

param:
* issuer: Issuer object;

### Publish issuer

**void publish_issuer(byte[] pub, Pointer issuer)**

comment:
* Get public key of the issuer;

param:
* pub: the issuer's public key (Because of the jna limits, you should make sure pub is empty);
* issuer: the issuer object;

### Get accumulator's value

**void get_accumulator_value(byte[] value, Pointer issuer)**

comment:
* Get accumulator's value;

param:
* value: the accumulator value of the issuer (Because of the jna limits, you should make sure value is empty); 
* issuer: issuer object;

### Get accumulator's info

**String get_accumulator_info(Pointer issuer)**

comment:
* Get the public information of the issuer's accumulator;

param:
* issuer: issuer object;

### Free string 

**free_str(String s)**

comment:
* used to free string managed by native code.

param:
* s: string to be released;

### New master key

**void new_master_secret(byte[] master_secret)**

comment:
* Generate a new master secret of the user.
* The buffer should be the size of 32.

param:
* master_secret: master secret of the user.

### Make issue request

**String make_issue_request(byte[] master_secret, String attributes, byte[] nonce, byte[] issuer_public)**

comment:
* Make a issue request with the master secret and attributes;
* The returned value is a json string, which should be freed via `free_str`;

param:
* master_secret: master secret of the user;
* attributes: json string;
* nonce: is a 16 bytes random value, which should be received from the issuer;
* issuer_public: issuer's public key;

The following is an example of attributes:
```json

     {
         "name": "Alice",
         "age": 22,
         "sex": "female"
     }
```

### Issue credential

**String issue_credential(Pointer issuer, String request)**

comment:
* Issue a credential according to the request, which is generated by user;
* The returned value is json string, which should be freed via `free_str`;

param:
* issuer: the issuer object;
* request: the user request;

### Revoke credential

**int revoke_credential(Pointer issuer, Long i)**

comment:
* Revoke the credential with the id `i` issued by `issuer`;

param:
* issuer: the issuer object;
* i: the credential index;

### Extract witness

**int extract_witness(byte[] witness, String credential)**

comment:
* Extract the witness from the issued credential.

param: 
* witness: the credential's witness value;
* credential: the credential json string;

### Update witness

**int update_witness(byte[] witness, byte[] new_witness, Pointer issuer, Long i, byte is_add)**

comment: 
* Update a witness after the accumulator is updated (new credential is issued or old credential is revoked).
* This should be called by the issuer, who manages the witnesses.

param:
* witness: should be the one extracted via `extract_witness`;
* new_witness: received new witness;
* issuer: the issuer object;
* i: the credential index
* is_add: should be 1, if a credential with id `i` is issued or 0, if the credential with id `i` is revoked;

### Update credential witness

**String update_credential_witness(String credential, byte[] issuer_public, byte[] witness, byte[] accumulator)**

comment:
* Update the accumulator witness in a credential, after the accumulator is updated (new credential issued or old credential revoked).

param:
* credential: is the credential data, which should be a json string;
* issuer_public: issuer's public key;
* witness: is the latest witness received from the issuer, whose size should be ACC_WITNESS_SIZE.
* accumulator: is the latest accumulator value, whose size should be 96.

### Make presentation

**String present(String credential, byte[] master_secret, String attributes, byte[] issuer_public, byte[] accumulator, byte[] nonce)**

comment:
* Present a credential;

param:
* credential: is the credential data, should be a json string.
* master_secret: user's master secret key;
* attributes: user's attribute;
* issuer_public: issuer's public key;
* accumulator: the newest accumulator value;
* nonce: the credential's nonce value;

### Verify presentation

**int verify(String presentation, byte[] issuer_public, byte[] accumulator, byte[] nonce)**

comment:
* Verify a presentation.

param:
* presentation: is the json string returned by `present`;is the json string returned by `present`
* issuer_public: the issuer's public key;
* accumulator: is the accumulator value, should be the same one when user calling `present` (usually the latest).
* nonce: is the same value passed to `present`.

## Anonymous Credential Record Contract

[code](../smartcontract/neovm/AnonymousRecord.java)

### bind

**public String bind(String ownerId, String pwd, byte[] salt, int index, byte[] publicKey, Account payerAcct, long gaslimit, long gasprice)**

Used to establish issuer ontid and anonymous credential public key's relationship.

### updateAccumulator

**public String updateAccumulator(String ownerId, String pwd, byte[] salt, int index, long id, byte[] accumulator, byte[] witness, Account payerAcct, long gaslimit, long gasprice)**

Used to update credential's accumulator on blockchain.

### revoke

**public String revoke(String ownerId, String pwd, byte[] salt, int index, long id, Account payerAcct, long gaslimit, long gasprice)**

Used to revoke credential on blockchain.

### getAccumulator

**public Accumulator getAccumulator(String ownerId, long id, long gaslimit, long gasprice)**

Used to get accumulator when credential owners or verifiers want to update or verify credential.

### getPublicKey

**public byte[] getPublicKey(String ownerId, long gaslimit, long gasprice)**

Used to get issuer public key by his ontid.

### getIssuerId

**public String getIssuerId(byte[] publicKey, long gaslimit, long gasprice)**

Used to get issuer ontid by his public key.

## How to Use
The [document](./anonymous%20credential.MD) is a simple introduction about how to use Ontology Anonymous Credential.
There are some [code](../../../../../../test/java/com/github/ontio/ontid/anonymous/AnonymousCredentialTest.java) to illustrate how to use Ontology Anonymous Credential sdk.
